<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Select Parameters</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    label { display: block; margin: 5px 0; }
    .controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h3>Select Parameters to Import</h3>
  <button onclick="submitSelection()">Import Selected</button>
  <button onclick="toggleAll(true)">Select All</button>
  <button onclick="toggleAll(false)">Deselect All</button>
  <form id="paramForm"></form>
  <!--
  <div class="controls">
    <button onclick="submitSelection()">Import Selected</button>
  </div>
  -->

  <script>
    let params = [];

    function toggleAll(checked) {
      document.querySelectorAll('#paramForm input[type=checkbox]').forEach(cb => cb.checked = checked);
    }

    function submitSelection() {
      const selected = [...document.querySelectorAll('#paramForm input[type=checkbox]:checked')].map(cb => cb.value);
      const msg = { action: 'import', selected };
      
      window.fusionJavaScriptHandler.handle("import", JSON.stringify(msg));
    }

    function addParamsToForm(paramsJson) {
      params = JSON.parse(paramsJson);
      const form = document.getElementById('paramForm');
      form.innerHTML = '';
      params.forEach(p => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" checked value="${p.name}"> ${p.name} (${p.expression || p.value} ${p.units})`;
        form.appendChild(label);
      });
    }

    // Fusion API calls this
    window.fusionJavaScriptHandler = {
      handle: function(action, data) {
        try {
          console.log("Received from Fusion:", data);
          switch(action) {
          case 'loadParams':
            loadParams(data)
            break; 
          
          case 'import':
            adsk.fusionSendData("messageFromPalette", JSON.stringify(data));
            break;

          case 'htmlReady':
            adsk.fusionSendData("htmlReady", JSON.stringify(data));
            break;

          }
            
        }
        catch(e) {
          console.log('exception caught with action: ' + action + ', data: ' + data);
        }
        
        return 'OK';
      }
    };

    // Called by Fusion API
    function loadParams(json) {
      addParamsToForm(json);
    }

  
  document.addEventListener('DOMContentLoaded', () => {
	let adskWaiter = setInterval(() => {
		if (window.adsk) {
			clearInterval(adskWaiter);
      const msg = { action: 'htmlReady'};
      
			adsk.fusionSendData('htmlReady', JSON.stringify(msg));
		}
	});
});

  </script>
</body>
</html>
